<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Resetting Password</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      text-align: center;
    }
    #status {
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Resetting Your Password...</h2>
  <p id="status">Verifying your recovery link...</p>

  <script>
    const env = window.env || {
      SUPABASE_URL: 'https://qpnjabqpixpzmoyxpqff.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwbmphYnFwaXhwem1veXhwcWZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MzI2ODAsImV4cCI6MjA2NjUwODY4MH0.TaL6ohOC6lxR9n5ChFKBdu8YlTyoOfLtWd1GR22Cj74'
    };

    const client = window.supabase.createClient(env.SUPABASE_URL, env.SUPABASE_ANON_KEY);

    async function handleRecovery() {
      const status = document.getElementById('status');
      const urlParams = new URLSearchParams(window.location.search);
      const accessToken = urlParams.get('access_token');
      const refreshToken = urlParams.get('refresh_token');
      const type = urlParams.get('type');

      if (!accessToken || !refreshToken || type !== 'recovery') {
        status.textContent = "‚ùå Invalid or incomplete recovery URL.";
        return;
      }

      try {
        const { data, error } = await client.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken,
        });

        if (error) {
          console.error("üî¥ Recovery error:", error.message);
          status.textContent = `‚ùå Recovery failed: ${error.message}`;
        } else {
          console.log("‚úÖ Session set:", data);
          status.textContent = "‚úÖ Link verified. Redirecting...";
          setTimeout(() => {
            window.location.href = "/update-password.html";
          }, 1500);
        }
      } catch (err) {
        console.error("üî¥ Unexpected error:", err);
        status.textContent = "‚ö†Ô∏è Unexpected error. See console.";
      }
    }

    handleRecovery();
  </script>
</body>
</html>
